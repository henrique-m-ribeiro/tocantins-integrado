{
  "name": "Data Collection - Scheduled Monthly",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 3 1 * *"
            }
          ]
        }
      },
      "id": "dcs001-cron",
      "name": "Monthly Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300],
      "notes": "Executa no dia 1 de cada mÃªs Ã s 3h"
    },
    {
      "parameters": {
        "jsCode": "// Determinar quais fontes verificar baseado no mÃªs\nconst now = new Date();\nconst currentMonth = now.getMonth() + 1;\nconst currentYear = now.getFullYear();\n\n// ConfiguraÃ§Ã£o de fontes e sua frequÃªncia de atualizaÃ§Ã£o\nconst sources = [\n  // AtualizaÃ§Ãµes mensais\n  { name: 'IBGE Sidra', endpoint: 'ibge-sidra', frequency: 'monthly', checkMonths: [1,2,3,4,5,6,7,8,9,10,11,12] },\n  { name: 'SICONFI', endpoint: 'siconfi', frequency: 'monthly', checkMonths: [1,2,3,4,5,6,7,8,9,10,11,12] },\n  { name: 'Comex Stat', endpoint: 'comex-stat', frequency: 'monthly', checkMonths: [1,2,3,4,5,6,7,8,9,10,11,12] },\n  \n  // AtualizaÃ§Ãµes trimestrais\n  { name: 'DataSUS', endpoint: 'datasus', frequency: 'quarterly', checkMonths: [1, 4, 7, 10] },\n  { name: 'SNIS', endpoint: 'snis', frequency: 'quarterly', checkMonths: [1, 4, 7, 10] },\n  \n  // AtualizaÃ§Ãµes anuais\n  { name: 'MapBiomas', endpoint: 'mapbiomas', frequency: 'annual', checkMonths: [8] }, // Agosto - nova coleÃ§Ã£o\n  { name: 'INEP', endpoint: 'inep', frequency: 'annual', checkMonths: [9] }, // Setembro - IDEB\n  { name: 'Atlas Brasil', endpoint: 'atlas-brasil', frequency: 'annual', checkMonths: [1] } // Janeiro\n];\n\n// Filtrar fontes que devem ser verificadas este mÃªs\nconst sourcesToCheck = sources.filter(s => s.checkMonths.includes(currentMonth));\n\nreturn {\n  currentMonth,\n  currentYear,\n  sourcesToCheck,\n  totalSources: sourcesToCheck.length,\n  startTime: now.toISOString()\n};"
      },
      "id": "dcs001-config",
      "name": "Determine Sources",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.totalSources }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "dcs001-check",
      "name": "Has Sources?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "// Gerar items para cada fonte a verificar\nconst input = $input.first().json;\n\nreturn input.sourcesToCheck.map(source => ({\n  json: {\n    source,\n    currentYear: input.currentYear,\n    startTime: input.startTime\n  }\n}));"
      },
      "id": "dcs001-split",
      "name": "Split Sources",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.COLLECTOR_SERVICE_URL }}/status/{{ $json.source.endpoint }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "dcs001-check-updates",
      "name": "Check for Updates",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1120, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasUpdates }}",
              "value2": true
            }
          ]
        }
      },
      "id": "dcs001-has-updates",
      "name": "Has Updates?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.COLLECTOR_SERVICE_URL }}/collect",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"collector\": \"{{ $json.source.endpoint }}\",\n  \"years\": [{{ $json.currentYear }}],\n  \"municipalities\": \"all\",\n  \"incrementalOnly\": true\n}",
        "options": {
          "timeout": 600000
        }
      },
      "id": "dcs001-collect",
      "name": "Run Collection",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1560, 100],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Processar resultado da coleta\nconst result = $input.first().json;\n\nreturn {\n  source: result.source?.name || 'unknown',\n  endpoint: result.source?.endpoint || 'unknown',\n  success: !result.error,\n  recordsCollected: result.recordsCollected || 0,\n  recordsUpdated: result.recordsUpdated || 0,\n  error: result.error || null,\n  duration: result.duration || 0\n};"
      },
      "id": "dcs001-process",
      "name": "Process Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 100]
    },
    {
      "parameters": {
        "jsCode": "// Marcar como sem atualizaÃ§Ãµes\nconst input = $input.first().json;\n\nreturn {\n  source: input.source?.name || 'unknown',\n  endpoint: input.source?.endpoint || 'unknown',\n  success: true,\n  recordsCollected: 0,\n  recordsUpdated: 0,\n  skipped: true,\n  reason: 'Sem atualizaÃ§Ãµes disponÃ­veis'\n};"
      },
      "id": "dcs001-skip",
      "name": "Mark Skipped",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "jsCode": "// Agregar todos os resultados\nconst results = $input.all();\n\nconst summary = {\n  totalSources: results.length,\n  collected: 0,\n  skipped: 0,\n  failed: 0,\n  totalRecordsCollected: 0,\n  totalRecordsUpdated: 0,\n  details: [],\n  errors: []\n};\n\nfor (const r of results) {\n  const data = r.json;\n  \n  if (data.skipped) {\n    summary.skipped++;\n  } else if (data.success) {\n    summary.collected++;\n    summary.totalRecordsCollected += data.recordsCollected || 0;\n    summary.totalRecordsUpdated += data.recordsUpdated || 0;\n  } else {\n    summary.failed++;\n    summary.errors.push({\n      source: data.source,\n      error: data.error\n    });\n  }\n  \n  summary.details.push(data);\n}\n\nsummary.completedAt = new Date().toISOString();\nsummary.status = summary.failed === 0 ? 'success' : 'partial';\n\nreturn summary;"
      },
      "id": "dcs001-aggregate",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 200]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "collection_logs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "collection_type": "scheduled",
            "started_at": "={{ $('Determine Sources').item.json.startTime }}",
            "completed_at": "={{ $json.completedAt }}",
            "status": "={{ $json.status }}",
            "total_records": "={{ $json.totalRecordsCollected }}",
            "records_updated": "={{ $json.totalRecordsUpdated }}",
            "collectors_run": "={{ $json.collected }}",
            "collectors_skipped": "={{ $json.skipped }}",
            "collectors_failed": "={{ $json.failed }}",
            "summary": "={{ JSON.stringify($json) }}"
          }
        }
      },
      "id": "dcs001-log",
      "name": "Log to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [2220, 200],
      "credentials": {
        "postgres": {
          "id": "postgres-supabase",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.failed }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "dcs001-check-errors",
      "name": "Has Errors?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2440, 200]
    },
    {
      "parameters": {
        "channel": "#data-collection",
        "text": "=âš ï¸ *Coleta Mensal com Erros*\n\nðŸ“… MÃªs: {{ $('Determine Sources').item.json.currentMonth }}/{{ $('Determine Sources').item.json.currentYear }}\n\nðŸ“Š *Resumo:*\nâ€¢ Fontes processadas: {{ $json.totalSources }}\nâ€¢ Coletadas: {{ $json.collected }}\nâ€¢ Puladas (sem atualizaÃ§Ã£o): {{ $json.skipped }}\nâ€¢ Com erro: {{ $json.failed }}\n\nðŸ“ˆ *Dados:*\nâ€¢ Novos registros: {{ $json.totalRecordsCollected }}\nâ€¢ Atualizados: {{ $json.totalRecordsUpdated }}\n\nâŒ *Erros:*\n{{ $json.errors.map(e => `â€¢ ${e.source}: ${e.error}`).join('\\n') }}",
        "otherOptions": {}
      },
      "id": "dcs001-notify-error",
      "name": "Notify Errors",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2,
      "position": [2660, 100],
      "credentials": {
        "slackApi": {
          "id": "slack-webhook",
          "name": "Slack Webhook"
        }
      }
    },
    {
      "parameters": {
        "channel": "#data-collection",
        "text": "=âœ… *Coleta Mensal ConcluÃ­da*\n\nðŸ“… MÃªs: {{ $('Determine Sources').item.json.currentMonth }}/{{ $('Determine Sources').item.json.currentYear }}\n\nðŸ“Š *Resumo:*\nâ€¢ Fontes processadas: {{ $json.totalSources }}\nâ€¢ Coletadas: {{ $json.collected }}\nâ€¢ Puladas (sem atualizaÃ§Ã£o): {{ $json.skipped }}\n\nðŸ“ˆ *Dados:*\nâ€¢ Novos registros: {{ $json.totalRecordsCollected }}\nâ€¢ Atualizados: {{ $json.totalRecordsUpdated }}",
        "otherOptions": {}
      },
      "id": "dcs001-notify-success",
      "name": "Notify Success",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2,
      "position": [2660, 300],
      "credentials": {
        "slackApi": {
          "id": "slack-webhook",
          "name": "Slack Webhook"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// NÃ£o hÃ¡ fontes para verificar este mÃªs\nreturn {\n  message: 'Nenhuma fonte programada para verificaÃ§Ã£o este mÃªs',\n  skipped: true\n};"
      },
      "id": "dcs001-no-sources",
      "name": "No Sources",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    }
  ],
  "connections": {
    "Monthly Trigger": {
      "main": [
        [{ "node": "Determine Sources", "type": "main", "index": 0 }]
      ]
    },
    "Determine Sources": {
      "main": [
        [{ "node": "Has Sources?", "type": "main", "index": 0 }]
      ]
    },
    "Has Sources?": {
      "main": [
        [{ "node": "Split Sources", "type": "main", "index": 0 }],
        [{ "node": "No Sources", "type": "main", "index": 0 }]
      ]
    },
    "Split Sources": {
      "main": [
        [{ "node": "Check for Updates", "type": "main", "index": 0 }]
      ]
    },
    "Check for Updates": {
      "main": [
        [{ "node": "Has Updates?", "type": "main", "index": 0 }]
      ]
    },
    "Has Updates?": {
      "main": [
        [{ "node": "Run Collection", "type": "main", "index": 0 }],
        [{ "node": "Mark Skipped", "type": "main", "index": 0 }]
      ]
    },
    "Run Collection": {
      "main": [
        [{ "node": "Process Result", "type": "main", "index": 0 }]
      ]
    },
    "Process Result": {
      "main": [
        [{ "node": "Aggregate Results", "type": "main", "index": 0 }]
      ]
    },
    "Mark Skipped": {
      "main": [
        [{ "node": "Aggregate Results", "type": "main", "index": 0 }]
      ]
    },
    "Aggregate Results": {
      "main": [
        [{ "node": "Log to Database", "type": "main", "index": 0 }]
      ]
    },
    "Log to Database": {
      "main": [
        [{ "node": "Has Errors?", "type": "main", "index": 0 }]
      ]
    },
    "Has Errors?": {
      "main": [
        [{ "node": "Notify Errors", "type": "main", "index": 0 }],
        [{ "node": "Notify Success", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "1",
  "triggerCount": 0,
  "tags": [
    { "name": "data-collection" },
    { "name": "scheduled" }
  ]
}
